/*! izi-api (Build date: 05-06-2015) */
'use strict';angular.module('APIServiceApp',[]).factory('APIService',['$http','$log','$timeout',function(a,b,c){var d,e,f,g,h,i=null;return e={endpoint:"/api/RESTLoyalty/RESTLoyalty/",clientUrl:"",fake:!1,debug:!0,currLoyaltyObject:{},validClientUrls:["http://pitapit.fr","http://urbun.fr","http://beautyburger.com","http://madamecroque.fr","http://planetalis.com","http://cooking.bigsister.biz","http://ffpizza.izipass.pro","http://le-b.izipass.pro"]},f={missingClientUrl:function(){return e.debug?b.error("Client URL is not set! Use APIService.set.clientUrl(xxx)"):0},invalidBarcode:function(a){return e.debug?b.error("Barcode is not valid:",a):0},notLoggedIn:function(){return e.debug?b.error("No client logged in"):0},addPassage:function(){return e.debug?b.error("AddPassage ERROR, API returned false."):0}},d={set:{clientUrl:function(a){e.clientUrl=a},endpoint:function(a){e.endpoint=a},debug:function(a){e.debug=!!a},fake:function(a){e.fake=!!a}},get:{callableUrl:function(a){return d.validate.clientUrl()?e.clientUrl+e.endpoint+a:f.missingClientUrl()},emptyData:function(){return h},debugState:function(){return e.debug},serverUrl:function(c){a.get(d.get.callableUrl("GetServerUrl?Hardware_Id="+c)).success(function(a){b.info('getServerUrl',a),d.set.clientUrl(a.Server_Url)}).error(function(a){e.debug?b.error(a):0})},loyaltyObject:function(h,i){return c(function(){var c=d.validate.barcode(h),j=d.validate.clientUrl();return c&&j?e.fake?(e.currLoyaltyObject=g,i(g)):void a.get(d.get.callableUrl("GetloyaltyObject?barcode="+h)).success(function(a){return b.info('DATA: ',a.Offers),e.currLoyaltyObject=a,i(a)}).error(function(a){return e.debug?b.error(a):0,i(!1)}):c?f.missingClientUrl():f.invalidBarcode(h)},0)},loyaltyObjectWithPassword:function(g,h,i){return c(function(){var c=d.validate.barcode(g),j=d.validate.clientUrl();return c&&j?void a.get(d.get.callableUrl("GetloyaltyObject?login="+g+"&password="+h)).success(function(a){return b.info('DATA: ',a.Offers),e.currLoyaltyObject=a,i(a)}).error(function(a){return e.debug?b.error(a):0,i(!1)}):c?f.missingClientUrl():f.invalidBarcode(g)},0)},formattedOffers:function(a){var c=a.Offers;b.info('offers',c);for(var d=[],e=0;e<c.length;e++)c[e].isValid&&d.push(c[e]);return d},emptyPassageObj:function(){return{Login:null,Password:null,Key:null,Barcode:e.currLoyaltyObject.Barcodes[0].Barcode,CustomerFirstName:e.currLoyaltyObject.CustomerFirstName,CustomerLastName:e.currLoyaltyObject.CustomerLastName,CustomerEmail:e.currLoyaltyObject.CustomerEmail,OrderTotalIncludeTaxes:0,OrderTotalExcludeTaxes:0,CurrencyCode:"EUR",Items:[],BalanceUpdate:{},OrderSpecificInfo:"2"}}},actions:{useOffer:function(a,b){if(d.validate.barcode(b)){var c=d.get.emptyPassageObj();return c.Offer={OfferObjectId:a,Barcode:b,Date:new Date},d.actions.addPassage(c)}return!1},useAvoir:function(a,b){var c=d.get.emptyPassageObj();c.BalanceUpdate={Id:a,UpdateValue:b}},addPassage:function(b){return console.log(b),console.log(i),i=null,i?void 0:i=a.post(d.get.callableUrl("AddPassage"),JSON.stringify(JSON.stringify(b))).success(function(a){return a})},register:function(b){return c(function(){return e.fake?g:a.post(d.get.callableUrl("Register"),JSON.stringify(JSON.stringify(b))).success(function(a){return e.currLoyaltyObject=a,a})},0)}},validate:{clientUrl:function(){return!!~e.validClientUrls.indexOf(e.clientUrl)},barcode:function(a){return new RegExp(/(^[0-9]{8,8}$)|(^[0-9]{10,10}$)|(^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$)/).test(a)}}},h={Barcodes:[],LoyaltyObjectId:0,CustomerId:0,LoyaltyClass:null,CustomerFirstName:null,CustomerLastName:null,CustomerEmail:null,Balances:[],Offers:[]},g=h,d}]);