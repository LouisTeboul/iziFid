/*! izi-api (Build date: 04-06-2015) */
"use strict";angular.module('APIServiceApp').directive('iziAccount',function(){return{restrict:"EA",replace:!0,transclude:!0,scope:{barcode:"@",clientUrl:"@",theme:"@",remoteCss:"@",otherModelValue:"=compareTo",firebase:"@",auto:"="},template:'<div><style id="izi-style"></style><div class="izi-account center-block"><md-progress-circular class="md-accent" md-mode="indeterminate" ng-if="!isReady"></md-progress-circular><div ng-if="isReady && barcode && !register"><div class="card"><i class="glyphicon glyphicon-remove pull-right hvr-grow" ng-click="disconnect()"></i><h2 class="text-center">{{data.LoyaltyClass}}</h2><div class="row"><div class="col-sm-3"><div class="barcode-container center-block"><img class="img-responsive center-block barcode-img" data-ng-src="{{clientUrl}}/{{data.Barcodes[0].BarcodeUrl}}" alt="" onerror="$(&quot;.barcode-container&quot;).slideUp(),$(&quot;.onMissingQR&quot;).fadeIn(&quot;slow&quot;)"><div class="text-center"><small class="blanc">Carte n° {{barcode}}</small></div></div></div><div class="col-sm-9"><h4 class="no-mg-vert" ng-if="data.CustomerFirstName"><b>Prénom</b> : {{data.CustomerFirstName}}</h4><h4 class="no-mg-vert" ng-if="data.CustomerLastName"><b>Nom</b> : {{data.CustomerLastName}}</h4><h4 class="no-mg-vert" ng-if="data.CustomerEmail"><b>Email</b> : <a data-ng-href="mailto:{{data.CustomerEmail}}">{{data.CustomerEmail}}</a></h4></div></div></div><!-- Offers --><ul class="izi-offers list-unstyled" ng-if="data.Offers.length > 0"><li class="bg-accent hvr-sink waves-effect" ng-click="showConfirm($event, data.Offers[0])"><b class="pull-right">x{{data.Offers.length}}</b><h3 class="text-center no-mg-vert fid-item-title">{{data.Offers[0].OfferClassDescription}}</h3><div class="text-center"><b>{{data.Offers[0].OfferObjectDescription}}</b><br></div></li></ul><!-- Balances --><ul class="izi-balances list-unstyled"><li data-ng-repeat="balance in data.Balances" class="{{balance.Value > 0 ? \'bg-accent\' : \'bg-rouge\'}}"><h3 class="text-center no-mg-vert fid-item-title">{{balance.BalanceName}}</h3><div class="text-center"><b>Solde: {{balance.Value}} {{balance.BalanceType === \'Dollar\' ? \'$\' : balance.BalanceType}}</b></div><div ng-if="balance.UseToPay"><div class="input-group"><input id="balancePaymentInput" class="form-control" ng-minlength="1" ng-pattern="/^[0-9.,]+$/" type="tel" ng-model="balancePayment.value" placeholder="Paiement en avoir..." required><div class="input-group-addon wave-effect" ng-click="(balancePayment.value && +balancePayment.value > 0) ? useBalanceToPay(balancePayment.value, balance) : 0">VALIDER</div></div></div></li></ul><div class="text-center" ng-if="data.CustomerEmail"><button class="button btn bg-accent no-radius hvr-sink activated waves-effect" ng-click="addPassage()"><i class="icon ion-plus"></i> AJOUTER UN PASSAGE</button></div><h5 class="text-center light" ng-if="data.CustomerEmail" ng-init="bipDate = getDate(data.Barcodes[0].LastBipDate)"><small>Dernier passage le: {{bipDate.getDate() + \'/\' + (bipDate.getMonth() + 1) + \'/\' + bipDate.getFullYear()}}</small></h5></div><!-- LOGIN VIEW --><div id="loginView" ng-if="isReady && !barcode && !register"><h2 class="title text-center">{{firebase ? customization.title : \'FIDÉLITÉ\'}}</h2><h4 class="blanc text-center subtitle">{{firebase ? customization.subtitle : \'Veuillez saisir votre numéro de carte ci-dessous\'}}</h4><form name="iziLoginForm"><input type="tel" class="center-block" name="barcodeId" ng-model="form.barcode" ng-minlength="8" ng-enter="login()" ng-pattern="/(^[0-9]*$)|(^[_a-z0-9]+(.[_a-z0-9]+)*@[a-z0-9-]+(.[a-z0-9-]+)*(.[a-z]{2,4})$)/" placeholder="N° de carte&#8230;" ng-change="autoLogin()" required> <input class="center-block" type="password" name="password" ng-model="form.password" ng-minlength="8" ng-enter="login()" placeholder="Mot de passe..." required></form><div class="clearfix"><button class="btn btn-lg center-block hvr-grow no-radius {{(iziLoginForm.barcodeId.$invalid || iziLoginForm.barcodeId.$pristine) ? \'bg-rouge\' : \'bg-accent\'}}" ng-disabled="iziLoginForm.barcodeId.$invalid || iziLoginForm.barcodeId.$pristine" ng-click="login()">Valider</button><br><!--<a href="" class="blanc cursor-pointer pull-right" ng-click="goRegister()">Enregistrer ma carte</a>--></div></div><!-- REGISTER VIEW --><div id="registerView" ng-if="register"><i class="glyphicon glyphicon-remove blanc pull-left hvr-grow" ng-click="backToLogin()"></i><div class="container-fluid"><h3 class="blanc text-center">Enregistrer Ma Carte<br><small>Tous les champs sont obligatoires</small></h3><form name="registerForm" class="form-horizontal" novalidate><div class="clearfix"><label for="barcode" class="col-sm-3">N° de carte</label><div class="form-group col-sm-9"><input id="barcode" name="barcode" class="form-control" type="text" ng-model="client.barcode" placeholder="N° de carte&#8230;" ng-minlength="8" required="" ng-init="client.barcode = registerBarcode"><div class="alert alert-danger" ng-if="registerForm.barcode.$invalid && !registerForm.barcode.$pristine"><p class="text-center">Ce numéro de carte n\'est pas valide</p></div></div></div><div class="clearfix"><label for="firstname" class="col-sm-3">Prénom</label><div class="form-group col-sm-9"><input id="firstname" name="firstname" class="form-control" type="text" ng-model="client.firstname" placeholder="Prénom&#8230;" ng-minlength="1" ng-pattern="/[a-zA-ZÀ-ÿ ][a-zA-ZÀ-ÿ ][a-zA-ZÀ-ÿ ]+/" required=""><div class="alert alert-danger" ng-if="registerForm.firstname.$invalid && !registerForm.firstname.$pristine"><p class="text-center">Ce champ doit comporter au moins 2 caractères</p></div></div></div><div class="clearfix"><label for="lastname" class="col-sm-3">Nom</label><div class="form-group col-sm-9"><input id="lastname" name="lastname" class="form-control" type="text" ng-model="client.lastname" placeholder="Nom&#8230;" ng-minlength="1" ng-pattern="/[a-zA-ZÀ-ÿ ][a-zA-ZÀ-ÿ ][a-zA-ZÀ-ÿ ]+/" required=""><div class="alert alert-danger" ng-if="registerForm.lastname.$invalid && !registerForm.lastname.$pristine"><p class="text-center">Ce champ doit comporter au moins 2 caractères</p></div></div></div><div class="clearfix"><label for="email" class="col-sm-3">Email</label><div class="form-group col-sm-9"><input id="email" name="email" class="form-control" type="email" ng-model="client.email" placeholder="Adresse Email&#8230;" ng-pattern="/^[_a-z0-9]+(.[_a-z0-9]+)*@[a-z0-9-]+(.[a-z0-9-]+)*(.[a-z]{2,4})$/" required=""><div class="alert alert-danger" ng-if="registerForm.email.$invalid && !registerForm.email.$pristine"><p class="text-center">Cette adresse email ne semble pas être valide</p></div></div></div><div class="clearfix"><label for="tel" class="col-sm-3">Tél.</label><div class="form-group col-sm-9"><input id="tel" name="tel" class="form-control" type="tel" ng-model="client.tel" placeholder="N° de téléphone&#8230;" ng-minlength="6" required=""><div class="alert alert-danger" ng-if="registerForm.tel.$invalid && !registerForm.tel.$pristine"><p class="text-center">Ce numéro de téléphone ne semble pas être valide</p></div></div></div><div class="clearfix"><label for="email" class="col-sm-3">Adresse</label><div class="form-group col-sm-9"><input id="address" name="address" class="form-control" type="text" ng-model="client.address" placeholder="Adresse&#8230;" ng-minlength="8" required=""><div class="alert alert-danger" ng-if="registerForm.address.$invalid && !registerForm.address.$pristine"><p class="text-center">Ce champ doit comporter au moins 8 caractères</p></div></div></div><div class="clearfix"><label for="zipcode" class="col-sm-3">Code Postal</label><div class="form-group col-sm-9"><input id="zipcode" name="zipcode" class="form-control" type="tel" ng-model="client.zipcode" placeholder="Code Postal&#8230;" ng-minlength="6" required=""><div class="alert alert-danger" ng-if="registerForm.zipcode.$invalid && !registerForm.zipcode.$pristine"><p class="text-center">Ce champ doit comporter au moins 6 caractères</p></div></div></div><div class="clearfix"><label for="email" class="col-sm-3">Ville</label><div class="form-group col-sm-9"><input id="city" name="city" class="form-control" type="text" ng-model="client.city" placeholder="Ville&#8230;" ng-minlength="2" required=""><div class="alert alert-danger" ng-if="registerForm.city.$invalid && !registerForm.city.$pristine"><p class="text-center">Ce champ doit comporter au moins 2 caractères</p></div></div></div><div class="clearfix"><label for="password" class="col-sm-3">Mot de Passe</label><div class="form-group col-sm-9"><input id="password" name="password" class="form-control" type="password" ng-model="client.password" placeholder="Mot de passe&#8230;" ng-minlength="8" required=""><div class="alert alert-danger" ng-if="registerForm.password.$invalid && !registerForm.password.$pristine"><p class="text-center">Votre mot de passe doit comporter au moins 8 caractères</p></div></div></div><div class="clearfix"><label for="password" class="col-sm-3">Mot de Passe (confirmation)</label><div class="form-group col-sm-9"><input id="passwordConfirm" name="passwordConfirm" class="form-control" type="password" ng-model="client.passwordConfirm" placeholder="Mot de passe (confirmation)&#8230;" compare-to="client.password" ng-minlength="8" required=""><div class="alert alert-danger" ng-if="client.password !== client.passwordConfirm && !registerForm.passwordConfirm.$pristine"><p class="text-center">Le mot de passe ne correspond pas</p></div></div></div><div class="text-center"><button id="submitRegister" class="btn bg-{{registerForm.$invalid ? \'rouge\' : \'accent\'}} btn-lg center-block text-center no-radius" ng-disabled="registerForm.$invalid || registerForm.$pristine" ng-click="submitRegister()">VALIDER</button></div></form></div></div></div></div>',link:function(a){'light'===a.theme&&angular.element('.izi-account').addClass('izi-light-theme')},controller:['$scope','$rootScope','$element','$attrs','$http','$window','$timeout','$log','$mdDialog','$mdToast','$animate','$firebaseObject','APIService',function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){return a.replace("http://fonts.googleapis.com/css?family=","").replace(/:.+/,"").replace("+"," ")}function o(a){var b=n(a.styling.mainFont),c=n(a.styling.secondaryFont);return"@import url("+a.styling.mainFont+");@import url("+a.styling.secondaryFont+");h1, h2, h3 { color: "+a.styling.mainColor+" !important; font-family:"+b+", Helvetica, Arial, sans-serif !important; }h4, h5, p, a, b, em, small, div { color: "+a.styling.secondaryColor+" !important; font-family: "+c+", Helvetica, Arial, sans-serif !important; }a, a:hover { color: "+a.styling.mainColor+" !important; }"}function p(b){(a.barcodeValid=!(!b||!m.validate.barcode(b)))?a.barcode=b:delete a.barcode}function q(){a.isReady=!1,m.get.loyaltyObject(a.barcode,function(c){a.isReady=!0,c===!1?(a.reset(),f.alert('Carte inconnue!'),b.scan()):c.CustomerFirstName||c.CustomerLastName||c.CustomerEmail?(a.data=c,a.data.Offers=m.get.formattedOffers(c),a.hideData=!1):(a.reset(),a.goRegister())})}if(m.set.clientUrl(a.clientUrl),a.isReady=!1,a.remoteCss){var r=a.remoteCss||'http://localhost:8001/remotecss.css';e.get(r).success(function(b){a.isReady=!0,angular.element(document).find('head').append("<style type='text/css'>"+b+"</style>"),angular.element('#izi-style').remove()}).error(function(b){a.isReady=!0,h.error(b)})}else if(a.firebase){var s=new Firebase(a.firebase);a.data=l(s),a.data.$loaded().then(function(b){a.isReady=!0,a.customization=b,angular.element(document).find('head').append("<style type='text/css'>"+o(a.customization)+angular.element('#izi-style').html().replace(/#123456/g,a.customization.styling.mainColor)+"</style>"),angular.element('#izi-style').remove()})["catch"](function(a){console.error("Error:",a)})}a.toastPosition={bottom:!0,top:!1,left:!1,right:!0},a.getToastPosition=function(){return Object.keys(a.toastPosition).filter(function(b){return a.toastPosition[b]}).join(' ')},a.toast=function(b){j.show(j.simple().content(b).position(a.getToastPosition()).hideDelay(1500))},a.form={},a.QRCodeValid=!0,a.client={};var t;d.$observe('barcode',function(b){console.log(b),p(b),a.barcodeValid?q():0}),a.customStyle?angular.element(document).find('head').prepend("<style type='text/css'>"+a.customStyle+"</style>"):0,a.getDate=function(a){return new Date(a)},a.disconnect=function(){f.confirm("Êtes-vous sûr de vouloir vous déconnecter ?")?function(){a.reset()}():0},a.goRegister=function(){a.register=!0},a.backToLogin=function(){a.register=!1,a.reset(),b.scan()},a.login=function(){p(a.form.barcode),a.barcodeValid?q():f.alert("Ce n° de carte n'est pas valide !")},a.autoLogin=function(){a.auto&&(p(a.form.barcode),a.barcodeValid?q():f.alert("Ce n° de carte n'est pas valide !"))},a.hideDialog=function(){i.hide(),$('md-backdrop, .md-dialog-container').remove()},a.reset=function(){delete a.barcode,delete b.cardNum,delete a.form.barcode},a.addPassage=function(){var c=m.get.emptyPassageObj();m.actions.addPassage(c).success(function(){return a.hideDialog(),a.toast("Un passage a bien été ajouté à cette carte"),a.reset(),g(function(){b.scan()},1600),!0})},a.useBalanceToPay=function(c,d){var e=m.get.emptyPassageObj();return~~d.Value<~~c?(f.alert('Ce montant est supérieur au total de la cagnotte'),!1):(e.BalanceUpdate={Id:d.Id,UpdateValue:-parseFloat(c)},h.info('adding Passage...',JSON.stringify(e)),m.actions.addPassage(e).success(function(){return i.hide(),a.hideDialog(),a.toast("Le paiement en avoir a bien été effectué"),a.reset(),g(function(){b.scan()},1600),!0}),void 0)},a.useOffer=function(c){var d=m.get.emptyPassageObj();d.Offer={OfferObjectId:c.OfferObjectId,Barcode:c.Barcode,Date:new Date+""},h.info('using offer...',JSON.stringify(d)),m.actions.addPassage(d).success(function(){return i.hide(),a.hideDialog(),a.toast("L'offre a bien été utilisée"),a.reset(),g(function(){b.scan()},1600),!0})},a.submitRegister=function(){var b={Barcode:a.client.barcode,FirstName:a.client.firstname,LastName:a.client.lastname,Email:a.client.email,Phone:a.client.tel,StreetAddress:a.client.address,ZipPostalCode:a.client.zipcode,City:a.client.city,Password:a.client.password,ConfirmPassword:a.client.passwordConfirm};m.actions.register(b).then(function(){a.barcode=a.client.barcode,a.register=!1,q()})},a.showConfirm=function(b,c){a.currentOffer=c,i.show({scope:a,preserveScope:!0,clickOutsideToClose:!0,targetEvent:b,template:'<md-dialog aria-label="Utiliser Offre">                                 <md-dialog-content class="sticky-container clearfix">                                     <md-subheader class="md-sticky-no-effect"><h3 style="margin-bottom: 0">Utiliser Cette Offre ?</h3></md-subheader>                                     <p style="padding-left: 16px;">Confirmez-vous l\'utilisation de cette offre ?</p>                                 </md-dialog-content>                                 <div class="md-actions" layout="row">                                  <div class="clearfix">                                    <md-button class="md-accent md-hue-3" ng-click="useOffer(currentOffer)">                                     VALIDER                                     </md-button>                                     <md-button class="md-warn" ng-click="hideDialog()">                                     ANNULER                                     </md-button>                                  </div>                                 </div>                             </md-dialog>'}).then(function(){},function(){})},a.showAddPassageConfirm=function(b){i.show({scope:a,preserveScope:!0,clickOutsideToClose:!0,targetEvent:b,template:'<md-dialog aria-label="Ajouter un Passage">                                 <md-dialog-content class="sticky-container clearfix">                                     <md-subheader class="md-sticky-no-effect"><h3 style="margin-bottom: 0">Ajouter un Passage ?</h3></md-subheader>                                     <p style="padding-left: 16px;">Confirmez-vous que ce client est passé en caisse sans utiliser d\'offre et/ou d\'avoir fidélité ?</p>                                 </md-dialog-content>                                 <div class="md-actions" layout="row">                                  <div class="clearfix">                                    <md-button class="md-accent md-hue-3" ng-click="addPassage()">                                     VALIDER                                     </md-button>                                     <md-button class="md-warn" ng-click="hideDialog()">                                     ANNULER                                     </md-button>                                  </div>                                 </div>                             </md-dialog>'}).then(function(){},function(){})},a.showAdvanced=function(a,b){return b.UseToPay!==!0?!1:(t=b,i.show({clickOutsideToClose:!0,targetEvent:a,controller:'DialogCtrl',template:'<md-dialog aria-label="Paiement En Avoir">                                 <md-dialog-content class="sticky-container clearfix">                                     <md-subheader class="md-sticky-no-effect">PAIEMENT EN AVOIR</md-subheader>                                     <div>                                         <form action="" name="balancePaymentForm" novalidate>                                            <md-input-container>                                                 <label>Montant</label>                                                 <input id="balancePaymentInput" ng-minlength="1" ng-pattern="/^[0-9.,]+$/" type="tel" ng-model="balancePayment.value" required>                                             </md-input-container>                                         </form>                                     </div>                                     </md-dialog-content>                                     <div class="md-actions" layout="row">                                      <div class="clearfix">                                         <md-button class="md-accent md-hue-3" ng-disabled="balancePaymentForm.$invalid || balancePaymentForm.$pristine" ng-click="useBalanceToPay(balancePayment.value)">                                         VALIDER                                         </md-button>                                         <md-button class="md-warn" ng-click="cancel()">                                         ANNULER                                         </md-button>                                      </div>                                     </div>                                 </md-dialog>'}).then(function(){},function(){}),h.info('dialog then'),g(function(){$('#balancePaymentInput').focus()},500),void 0)},p(a.barcode),a.barcodeValid?q():a.hideData=!0}]}}).directive('ngEnter',function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).controller('DialogCtrl',['$scope','$rootScope','$mdDialog',function(a,b,c){a.hide=function(){c.hide(),$('md-backdrop, .md-dialog-container').remove()},a.cancel=function(){c.cancel(),$('md-backdrop, .md-dialog-container').remove()},a.useBalanceToPay=function(c){b.useBalanceToPay(c),a.hide()}}]).directive('compareTo',function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(a,b,c,d){d.$validators.compareTo=function(b){return b===a.otherModelValue},a.$watch("otherModelValue",function(){d.$validate()})}}});